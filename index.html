<!DOCTYPE html>

<html>
<head>
<title>MathPad</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 16 16'><text x='0' y='14'>Î£</text></svg>"/>
<link rel="stylesheet" type="text/css" href=" https://cdn.jsdelivr.net/npm/mathquill@0.10.1-a/build/mathquill.min.css">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathquill@0.10.1-a/build/mathquill.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/mathlive"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/light/style.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"/>
</head>
<style>
body {
  display: flex;
  flex-direction: column;
  margin: 0;
  min-height: 100vh;
}
.menu, #cmdinfo, #content, #foo {
  padding: 1ch;
}
/* svg from https://phosphoricons.com */
#choose_file {
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"/><path d="M32,208V64a8,8,0,0,1,8-8H93.33a8,8,0,0,1,4.8,1.6L128,80h72a8,8,0,0,1,8,8v24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="8"/><path d="M32,208l30.18-90.53A8,8,0,0,1,69.77,112H232a8,8,0,0,1,7.59,10.53L211.09,208Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="8"/></svg>') no-repeat;
    color: transparent;
    border: 1px solid grey;
    border-radius: 4px;
    background-position: center center;
}
.menu * {
    font-size: 20px;
}
#choose_file * {
    font-size: 15px;
}
i {
    vertical-align: text-bottom;
}
.menu button {
    border: none;
    border-radius: 4px;
    padding: 0px 4px;
}
.ph-check-circle {
    color: green;
}
#cb_server:not(:checked) + label {
    color: grey;
}
#setting:not(:checked) ~ div:has(#config_tab) {
    display: none;
}
#setting:checked ~ .menu [title=settings] {
    background: #ccc;
}
#fx, #fx *  {
    font-family: Times;
    font-size: 16px;
}
#content::before {
    content: "LaTeX: ";
    font-size: larger;
}
#cmdinfo {
    background: #ddd;
    border: 3px solid white;
    border-left-color: #aaa;
    border-top-color: #aaa;
    padding: 5px;
}
.merge, #config_tab > b {
    grid-column: span 2;
}
#config_tab label, #config_tab div {
    grid-column: 2;
    user-select: none;
}
#show_latex,
#show_latex:not(:checked) ~ #content,
#show_latex:checked ~ div #config_tab label :not(:checked),
#show_latex:not(:checked) ~ div #config_tab label :checked {
    display: none;
}
#config_tab label > input {
    pointer-events: none
}
math-field {
    min-width: 1ch;
    font-size: 1.2rem;
}
math-field::part(menu-toggle),
math-field::part(virtual-keyboard-toggle) {
    display: none;
}
</style>

<body>
<input type="checkbox" id="show_latex">
<input type="checkbox" id="setting" style="display: none">
<div class="menu" style="background: #eee; display: flex; padding: 1px 1ch;">
<button title="Upload" onclick="load_file()"><i class="ph-light ph-upload"></i></button>
<select id="choose_file" onclick="list_files(url='list');  this.value = (cb_server.checked ? 'server' : 'cache') + '_files '+ filepath.value" onchange="[optgroup, filepath.value] = this.value.split(' '); cb_server.checked = optgroup == 'server_files'; open_file()" style="width: 25px;">
  <optgroup id="cache_files" label="localStorage">
  <optgroup id="server_files" label="server">
  </select><button><input type="checkbox" id="cb_server" style="display: none"><label for="cb_server" title="server"><i class="ph-light ph-hard-drives"></i></label></button><input type="entry" id="filepath" oninput="save.disabled = false">
  <button id="save" type="button" title="save on server" onclick="cmdinfo.innerHTML = 'saving '+filepath.value  + (cb_server.checked ? ' on disk' : ' in localStorage'); put(filepath.value, foo2text())"><i class="ph-light ph-floppy-disk"></i> save</button>
  <button><a href="mathpad.txt" download='mathpad.txt' id="download_link" title="Download" onmousedown='document.getElementById("download_link").href = "data:text/plain," + encodeURI(foo2text());' style="text-decoration: none;color: black;"><i class="ph-light ph-download"></i></a></button>
  <button id="trash" type="button" title="delete file" onclick="delete_file(filepath.value)"><i class="ph-light ph-trash"></i></button>
  <div style="width: 20px"></div>
  <button id="clipboard" title="copy to clipboard" onclick="copy()"><i class="ph-light ph-copy"></i></button>
  <div style="flex: 1 0 auto"></div>
  <button id="fx" title="insert math" onclick="insert_math()"><i>f</i>(<i>x</i>)</span></button>
  <div style="flex: 1 0 auto"></div>
  <button title="settings"><label for="setting"><i class="ph-light ph-gear-six"></i></label></button>
  <button><a href="https://github.com/mzechmeister/mathpad" title="MathPad @ github" style="color: inherit; text-decoration: inherit;"><i class="ph-fill ph-github-logo"></i></a></button>
</div>

<div>
<div id="config_tab" style="background: #eee; margin: 10px; padding: 1ch; position: absolute; right: 2ch; z-index: 4;
   display: grid; grid-template-columns: auto auto; grid-gap: 10px;">
    <div>
      <input type="radio" id="mq" name="math_editor"> <label for="mq">MathQuill</label>
      <input type="radio" id="ml" name="math_editor" checked> <label for="ml">MathLive</label>
    </div>
    <b>MathQuill configs</b>
    autoCommands: <input id="autoCommands" type="entry" value="alpha beta delta gamma pi sigma theta sqrt sum int" style="width: 400px">
    autoOperatorNames: <input id="autoOperatorNames" type="entry" value="" style="width: 400px">
    <b>Display</b>
    <label for="show_latex"><input type="checkbox" checked><input type="checkbox"> show LaTeX</label>
  <button class="merge" onclick="mq_config()" style="margin: 0 auto; display: block;">Apply</button>
</div>
</div>

<p id="foo" contenteditable="true" style="white-space: pre-wrap; flex: 1"></p>

<code id="content">Type two dollar signs to enter math mode. Then you can write LaTeX equations like $f\left(x\right)=\exp\left(-\frac{1}{2}\left(\frac{x}{\sigma}\right)^2\right)$.</code>
<div id="cmdinfo" style="padding: 0ch 1ch; font-family: 'Mono'"></div>

<script>
function mq_config() {
    conf = {}
    if (autoOperatorNames.value) conf['autoOperatorNames'] = autoOperatorNames.value
    if (autoCommands.value) conf['autoCommands'] = autoCommands.value
    MQ.config(conf)
    setting.checked = false
}

function copy() {
    content.innerHTML = foo2text()
    window.getSelection().selectAllChildren(content)
    document.execCommand('copy')
    clipboard.firstChild.classList.add('ph-fill', 'ph-check-circle')
    clipboard.firstChild.classList.remove('ph-light', 'ph-copy')
    setTimeout(() => {clipboard.firstChild.classList.remove('ph-fill', 'ph-check-circle');
                      clipboard.firstChild.classList.add('ph-light', 'ph-copy')}, 2000)
}

function load_file() {
    input = document.createElement('input');
    input.type = 'file'
    input.onchange = e => {
        var file = e.target.files[0]
        var reader = new FileReader()
        reader.readAsText(file,'UTF-8')
        reader.onload = readerEvent => {
            var textcontent = readerEvent.target.result
            content.innerHTML = textcontent
            text2foo()
        }
    }
    input.click()
}

function foo2text() {
    text = ''
    for (x of [...foo.childNodes]) {
        if (x.editor) {text += '$'+x.editor.latex()+'$'}
        else if (x._mathfield) {text += '$'+x.innerHTML+'$'}
        else if (x.textContent) text += x.textContent
    }
    return text
}

function text2foo() {
    foo.innerHTML = ''
    for (const [i,x] of content.innerHTML.split("$").entries()) {
        if (i%2) {aa = create_math()}
        else {aa = document.createTextNode(x)}
        foo.append(aa)
        if (aa.editor) aa.editor.latex(x)  // Seems to work only after append, the brackets in the inital expression are rendered properly.
        if (aa.tagName == "MATH-FIELD") aa.innerHTML = x
    }
}

function create_ml() {
    mf = document.createElement('math-field')
    return mf
}

function create_mq() {
    mqSpan = document.createElement('span')
    var mq = MQ.MathField(mqSpan, {
               spaceBehavesLikeTab: true, // configurable
               handlers: {
                   edit: function() { // useful event handlers
                       content.innerHTML = mq.latex(); // simple API
                   }
               }
    })
    mqSpan.editor = mq
    mqSpan.onfocus = () => content.innerHTML = mq.latex()
    mqSpan.focus = () => mq.focus()
    return mqSpan
}

gg = {}
gg.ml = create_ml
gg.mq = create_mq
create_math = (e) => gg[document.querySelector('input[name="math_editor"]:checked').id](e)

// insert mathmode for short cut $$
foo.oninput = (e) => {
    save.disabled = false
    sel = window.getSelection()
    range = sel.getRangeAt(0)
    if (e.data == '$' && range.startContainer.textContent.substr(range.startOffset-2,2)  == '$$') {
        range.setStart(range.startContainer, range.startOffset-2)
        range.deleteContents()
        mqSpan = create_math()
        range.insertNode(mqSpan)
        mqSpan.focus()
    }
}

function insert_math() {
    sel = window.getSelection()
    if (foo.contains(sel.focusNode) && sel.focusOffset > 0) {
        document.execCommand("insertText", false, '$')
        document.execCommand("insertText", false, '$')
    }
}

// handle cursor transition into and out of MQ
foo.addEventListener("keydown", e => {
    mqcursor = document.querySelector(".mq-cursor")
    if (mqcursor) mqroot = mqcursor.closest('.mq-root-block')
    sel = window.getSelection()
    if ((mqcursor && e.key=="Backspace" && mqroot.firstChild == mqcursor) ||
        (mqcursor && e.key=="Delete" && mqroot.lastChild == mqcursor)) {
        mqspan = mqroot.parentElement
        sel.setBaseAndExtent(mqspan.previousSibling, mqspan.previousSibling.length, mqspan.nextSibling, 0)
        document.execCommand("insertText", false, '')
    }
    if (e.key=="ArrowLeft") {
        if (mqcursor) {
            if (mqroot.firstChild == mqcursor) {
                foo.focus()
                prev = e.target.parentElement.parentElement.previousSibling
                set_caret(prev, prev.length)
            }
        } else if (e.target.tagName == "MATH-FIELD") {
            if (e.target.selection.ranges[0][0] == 0) {
                foo.focus()
                prev = e.target.previousSibling
                set_caret(prev, prev.length)
            }
        } else {
            prev = sel.anchorNode.previousElementSibling
            if (prev && prev.classList.contains("mq-editable-field") && sel.anchorOffset == 0) {
                prev.editor.focus()
                prev.editor.moveToRightEnd()
            } else if (prev && prev.tagName == "MATH-FIELD" && sel.anchorOffset == 0) {
                prev.focus()
                prev.executeCommand("moveToMathfieldEnd")
            }
        }
    }
    if (e.key=="ArrowRight") {
        if (mqcursor) {
            if (mqroot.lastChild == mqcursor) {
                foo.focus()
                next = e.target.parentElement.parentElement.nextSibling
                set_caret(next, 0)
            }
        } else if (e.target.tagName == "MATH-FIELD") {
            if (e.target.selection.ranges[0][0] == e.target.lastOffset) {
                foo.focus()
                next = e.target.nextSibling
                set_caret(next, 0)
            }
        } else {
            next = sel.anchorNode.nextElementSibling;
            if (next && next.classList.contains("mq-editable-field") && sel.anchorOffset == sel.anchorNode.data.length) {
                next.editor.focus()
                next.editor.moveToLeftEnd()
            } else if (next && next.tagName == "MATH-FIELD" && sel.anchorOffset == sel.anchorNode.data.length) {
                next.focus()
                next.executeCommand("moveToMathfieldStart")
            }
        }
    }
}, true)   // true: must be triggered before mq moves cursor

function set_caret(elem, pos) {
    range = document.createRange()
    range.setStart(elem, pos)
    range.collapse(true)
    sel.removeAllRanges()
    sel.addRange(range)
}

function tabulate_files(filenames, optgroup) {
    if (JSON.stringify([...optgroup.children].map(x => x.value)) == JSON.stringify(filenames.map(x => optgroup.id +" " +x))) return
    optgroup.innerHTML = ''
    for (name of filenames) {
        opt = document.createElement("option")
        opt.value = optgroup.id + " " + name
        opt.innerHTML += name
        optgroup.append(opt)
    }
}

function list_files(url="list") {
    tabulate_files(Object.keys(localStorage), cache_files)
    fetch(url).then(function(response) {
        return response.json()
    }).then(function(data) {
        tabulate_files(data.map(x => x.name), server_files)
    })
}

function open_file() {
    cmdinfo.innerHTML = 'reading ' + filepath.value + ' from ' + (cb_server.checked ? 'disk' : 'localStorage')
    get((cb_server.checked ? 'data/' : '') + filepath.value)
}

function delete_file(filename) {
    var msg_ok = () =>  cmdinfo.innerHTML = filename+" deleted"
    if (cb_server.checked) {
        var url = '/files?name='+filename
        fetch(url, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/text'
            },
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network response error')
            } else {
                msg_ok()
            }
        }).catch(error => {
            console.error('a problem occured during deleting', error);
            cmdinfo.innerHTML = "<span style='color:red'>Error: File '"+filename+"' could not be deleted.</span>"
        })
    } else {
        localStorage.removeItem(filename)
        msg_ok()
    }
}

function display_data(data) {
    content.innerHTML = data
    save.disabled = true
    text2foo()
}

function get(filename) {
    if (cb_server.checked) {
        fetch(filename, {cache: "no-store"}).then(function(response) {
            return response.text()
        }).then(function(data) {
            display_data(data)
        })
    } else {
        display_data(localStorage[filename])
    }
}

function put(filename, text) {
    save_info = data => {
        console.log('file', filename, 'updated:', data)
        save.disabled = true
        cmdinfo.innerHTML = filename + " saved"
    }

    if (cb_server.checked) {
        var url = '/files?name='+filename
        fetch(url, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/text'
            },
            body: text
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network response error')
            }
            return response.json()
        }).then(save_info).catch(error => {
            console.error('a problem occured during saving', error);
            cmdinfo.innerHTML = "<span style='color:red'>Error: File '"+filename+"' could not be saved.</span>"
        })
    } else {
        localStorage[filename] = text
        save_info(text)
    }
}

MQ = MathQuill.getInterface(2)
mq_config()

list_files(url='list')
filepath.value ? open_file() : text2foo()
</script>

</body>
</html>
