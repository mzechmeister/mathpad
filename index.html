<!DOCTYPE html>

<html>
<head>
<title>MathPad</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 16 16'><text x='0' y='14'>Î£</text></svg>"/>
<link rel="stylesheet" type="text/css" href=" https://cdn.jsdelivr.net/npm/mathquill@0.10.1-a/build/mathquill.min.css">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathquill@0.10.1-a/build/mathquill.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/light/style.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"/>
</head>
<style>
/* svg from https://phosphoricons.com */
#choose_file {
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"/><path d="M32,208V64a8,8,0,0,1,8-8H93.33a8,8,0,0,1,4.8,1.6L128,80h72a8,8,0,0,1,8,8v24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="8"/><path d="M32,208l30.18-90.53A8,8,0,0,1,69.77,112H232a8,8,0,0,1,7.59,10.53L211.09,208Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="8"/></svg>') no-repeat;
    color: transparent;
    border: 1px solid grey;
    border-radius: 4px;
    background-position: center center;
}
.menu * {
    font-size: 20px;
}
i {
    vertical-align: text-bottom;
}
button {
    border: none;
    border-radius: 4px;
    padding: 0px 4px;
}
</style>

<body>
<div class="menu" style="background: #eee; display: flex; padding: 1px 1ch;">
<button title="Upload" onclick="load_file()"><i class="ph-light ph-upload"></i></button>
<select id="choose_file" onclick="list_files(url='list'); this.value = filepath.value" onchange="filepath.value = this.value; open_file()" style="width: 25px;">
  </select><input type="entry" id="filepath" oninput="save.disabled = false">
  <button id="save" type="button" title="save on server" onclick="cmdinfo.innerHTML = 'saving '+filepath.value; put(filepath.value, foo2text())"><i class="ph-light ph-floppy-disk"></i> save</button>
  <button><a href="mathpad.txt" download='mathpad.txt' id="download_link" title="Download" onmousedown='document.getElementById("download_link").href = "data:text/plain," + encodeURI(foo2text());' style="text-decoration: none;color: black;"><i class="ph-light ph-download"></i></a></button>
  <div style="flex: 1 0 auto"></div>
  <button id="bar" style="float: right;"><a href="https://github.com/mzechmeister/mathpad" title="github" style="  color: inherit; text-decoration: inherit;"><i class="ph-fill ph-github-logo"></i></a></button>
</div>

<p id="foo" contenteditable="true" style="white-space: pre-wrap;">type two $ to enter mathmode</p>

LaTeX: <code id="content"></code>
<div id="cmdinfo" style="background: #eee;padding: 0ch 1ch; font-family: 'Mono'"></div>

<script>

function load_file() {
    input = document.createElement('input');
    input.type = 'file'
    input.onchange = e => {
        var file = e.target.files[0]
        var reader = new FileReader()
        reader.readAsText(file,'UTF-8')
        reader.onload = readerEvent => {
            var textcontent = readerEvent.target.result
            content.innerHTML = textcontent
            text2foo()
        }
    }
    input.click()
}

function foo2text() {
    text = ''
    for (x of [...foo.childNodes]) {
        if (x.editor) {text += '$'+x.editor.latex()+'$'}
        else if (x.textContent) text += x.textContent
    }
    return text
}

function text2foo() {
    foo.innerHTML = ''
    for (const [i,x] of content.innerHTML.split("$").entries()) {
        if (i%2) {aa = create_mq(x)}
        else {aa = document.createTextNode(x)}
        foo.append(aa)
    }
}

function create_mq(contenttext='') {
    mqSpan = document.createElement('span')
    MQ = MathQuill.getInterface(2)
    var mq = MQ.MathField(mqSpan, {
               spaceBehavesLikeTab: true, // configurable
               handlers: {
                   edit: function() { // useful event handlers
                       content.innerHTML = mq.latex(); // simple API
                   }
               }
    })
    if (contenttext) mq.latex(contenttext)
    mqSpan.editor = mq
    mqSpan.onfocus = () => content.innerHTML = mq.latex()
    return mqSpan
}

// insert mathmode for short cut $$
foo.oninput = (e) => {
    save.disabled = false
    sel = window.getSelection()
    range = sel.getRangeAt(0);
    if (e.data == '$' && range.startContainer.textContent.substr(range.startOffset-2,2)  == '$$') {
        range.setStart(range.startContainer, range.startOffset-2)
        range.deleteContents();
        mqSpan = create_mq()
        range.insertNode(mqSpan)
        mqSpan.editor.focus()
    }
}

// handle cursor transition into and out of MQ
foo.addEventListener("keydown", e=> {
    mqcursor = document.querySelector(".mq-cursor")
    sel = window.getSelection()
    if (e.key=="ArrowLeft") {
        if (mqcursor) {
            if (mqcursor.parentElement.firstChild == mqcursor) {
                foo.focus()
                prev = e.target.parentElement.parentElement.previousSibling
                set_caret(prev, prev.length)
            }
            return
        }
        else {
            prev = sel.anchorNode.previousElementSibling;
            if (prev && sel.anchorOffset==0 && prev.classList.contains("mq-editable-field")) {
                prev.editor.focus()
                prev.editor.moveToRightEnd()
            }
        }
    }
    if (e.key=="ArrowRight") {
        if (mqcursor) {
            if (mqcursor.parentElement.lastChild == mqcursor) {
                foo.focus()
                next = e.target.parentElement.parentElement.nextSibling
                set_caret(next, 0)
            }
            return
        }
        else {
            next = sel.anchorNode.nextElementSibling;
            if (next && sel.anchorOffset==sel.anchorNode.data.length && next.classList.contains("mq-editable-field")) {
                next.editor.focus()
                next.editor.moveToLeftEnd()
            }
        }
    }
}, true)   // true: must be triggered before mq moves cursor

function set_caret(elem, pos) {
    range = document.createRange()
    range.setStart(elem, pos)
    range.collapse(true)
    sel.removeAllRanges()
    sel.addRange(range)
}

function tabulate_files(data) {
    if (JSON.stringify([...choose_file.options].map(o => o.value)) == JSON.stringify((data.map(x => x.name)))) return
    choose_file.innerHTML = ''
    for (x of data) {
        opt = document.createElement("option")
        opt.value = x.name
        opt.innerHTML = x.name
        choose_file.append(opt)
    }
}

function list_files(url="list") {
    fetch(url).then(function(response) {
        return response.json()
    }).then(function(data) {
        tabulate_files(data)
    })
}

function open_file() {
    cmdinfo.innerHTML = 'reading ' + filepath.value
    get('data/'+filepath.value)
}

function get(filename) {
    fetch(filename, {cache: "no-store"}).then(function(response) {
        return response.text()
    }).then(function(data) {
        content.innerHTML = data
        save.disabled = true
        text2foo()
    })
}

function put(filename, text) {
    var url = '/files?name='+filename
    fetch(url, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/text'
        },
        body: text
    }).then(response => {
        if (!response.ok) {
            throw new Error('Network response error')
        }
        return response.json()
    }).then(data => {
        console.log('file updated:', data);
        save.disabled = true
        cmdinfo.innerHTML = filename+" saved"
    }).catch(error => {
        console.error('a problem occured during saving', error);
        cmdinfo.innerHTML = "<span style='color:red'>Error: File '"+filename+"' could not be saved.</span>"
    })
}

list_files(url='list')
if (filepath.value) open_file()
</script>

</body>
</html>
